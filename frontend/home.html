<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cloud Drive - My Drive</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-content">
        <h1 class="nav-title">Cloud Drive</h1>
        <div class="nav-right">
          <input
            type="text"
            id="searchBar"
            placeholder="Search files..."
            class="search-bar"
          />
          <button class="btn-secondary" id="uploadBtn">Upload</button>
          <button class="btn-secondary" id="newFolderBtn">New Folder</button>
          <div class="user-info">
            <span id="userName"></span>
            <button class="btn-link" id="logoutBtn">Logout</button>
          </div>
        </div>
      </div>
    </nav>

    <div class="main-container">
      <div class="content-area">
        <div class="toolbar">
          <h2>My Drive</h2>
          <div class="filters">
            <select id="sortBy">
              <option value="name">Sort by Name</option>
              <option value="date">Sort by Date</option>
              <option value="type">Sort by Type</option>
              <option value="size">Sort by Size</option>
            </select>
          </div>
        </div>

        <div class="file-list" id="fileList">
          <!-- Files and folders will be dynamically generated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Hidden file input element -->
    <input type="file" id="fileInput" style="display: none" multiple />

    <!-- New folder modal -->
    <div id="folderModal" class="modal" style="display: none">
      <div class="modal-content">
        <h3>New Folder</h3>
        <input
          type="text"
          id="folderNameInput"
          placeholder="Enter folder name"
          maxlength="50"
        />
        <div class="modal-buttons">
          <button class="btn-primary" id="confirmFolderBtn">Confirm</button>
          <button class="btn-secondary" id="cancelFolderBtn">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Share link modal -->
    <div id="shareModal" class="modal" style="display: none">
      <div class="modal-content">
        <h3>Share Link</h3>
        <p style="margin-bottom: 15px; color: #666">
          Share this link to give others access:
        </p>
        <div class="share-link-container">
          <input
            type="text"
            id="shareLinkInput"
            readonly
            class="share-link-input"
          />
          <button class="btn-copy" id="copyLinkBtn">Copy</button>
        </div>
        <div class="modal-buttons">
          <button class="btn-secondary" id="closeShareBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- Move file/folder modal -->
    <div id="moveModal" class="modal" style="display: none">
      <div class="modal-content">
        <h3>Move to Folder</h3>
        <p style="margin-bottom: 15px; color: #666" id="moveItemName">
          Select destination folder:
        </p>
        <div class="folder-list-container">
          <div class="folder-option" data-folder-id="root">
            <span class="folder-icon">üìÅ</span>
            <span class="folder-name">My Drive (Root)</span>
          </div>
          <div id="moveFolderList"></div>
        </div>
        <div class="modal-buttons">
          <button class="btn-secondary" id="cancelMoveBtn">Cancel</button>
        </div>
      </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script>
      // Mock user data
      const mockUser = {
        id: "user123",
        name: "Susie Doe",
        email: "john.doe@example.com",
        storageQuota: 5368709120, // 5GB
        storageUsed: 1073741824, // 1GB
      };

      // Mock file data
      const mockFiles = [
        {
          id: "file1",
          name: "sunset.jpg",
          type: "image",
          size: 2456789, // bytes
          uploadDate: "2024-01-15",
          icon: "üñºÔ∏è",
          owner: "Susie Doe",
          folderId: null, // Root directory
        },
        {
          id: "file2",
          name: "document.pdf",
          type: "file",
          size: 1024567,
          uploadDate: "2024-01-14",
          icon: "üìÑ",
          owner: "Susie Doe",
          folderId: null, // Root directory
        },
        {
          id: "file3",
          name: "video.mp4",
          type: "video",
          size: 45678901,
          uploadDate: "2024-01-13",
          icon: "üé•",
          owner: "Susie Doe",
          folderId: null, // Root directory
        },
        {
          id: "file4",
          name: "assignment1.doc",
          type: "file",
          size: 512345,
          uploadDate: "2024-01-10",
          icon: "üìÑ",
          owner: "Susie Doe",
          folderId: "folder1", // test1 folder
        },
        {
          id: "file5",
          name: "assignment2.jpg",
          type: "image",
          size: 1890123,
          uploadDate: "2024-01-09",
          icon: "üñºÔ∏è",
          owner: "Susie Doe",
          folderId: "folder1", // test1 folder
        },
      ];

      // Mock folder data
      const mockFolders = [
        {
          id: "folder1",
          name: "test1",
          type: "folder",
          uploadDate: "2024-01-12",
          icon: "üìÅ",
          owner: "Susie Doe",
        },
        {
          id: "folder2",
          name: "test2",
          type: "folder",
          uploadDate: "2024-01-11",
          icon: "üìÅ",
          owner: "Susie Doe",
        },
      ];

      // Current folder state
      let currentFolderId = null;
      let selectedFileId = null;

      // Use mock user
      const user = mockUser;

      // Display user information
      document.getElementById("userName").textContent = user.name;

      // Generate random date (within past 30 days)
      function generateRandomDate() {
        const today = new Date();
        const daysAgo = Math.floor(Math.random() * 30);
        const date = new Date(today);
        date.setDate(date.getDate() - daysAgo);
        return date.toISOString().split("T")[0];
      }

      // Generate random dates for all files and folders
      mockFiles.forEach((file) => {
        file.uploadDate = generateRandomDate();
      });

      mockFolders.forEach((folder) => {
        folder.uploadDate = generateRandomDate();
      });

      // Format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i]
        );
      }

      // Format date
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      // Update toolbar title
      function updateToolbarTitle(title) {
        document.querySelector(".toolbar h2").textContent = title;
      }

      // Render file and folder list
      function renderFileList(folderId = null) {
        const fileListContainer = document.getElementById("fileList");
        fileListContainer.innerHTML = "";

        // Add header row
        const headerRow = document.createElement("div");
        headerRow.className = "file-item header-row";
        headerRow.innerHTML = `
          <div class="file-name-cell">
            <span class="file-name">Name</span>
          </div>
          <span class="file-owner">User</span>
          <span class="file-size">Size</span>
          <span class="file-date">Date</span>
          <div class="file-actions"></div>
          <div class="file-actions"></div>
          <div class="file-actions"></div>
          <div class="file-actions"></div>
        `;
        fileListContainer.appendChild(headerRow);

        // If there's a current folder, show back button
        if (folderId) {
          const backBtn = document.createElement("div");
          backBtn.className = "file-item back-item";
          backBtn.innerHTML = `
            <div class="file-name-cell">
              <span class="file-icon">‚Üê</span>
              <span class="file-name">Back</span>
            </div>
            <span class="file-owner"></span>
            <span class="file-size"></span>
            <span class="file-date"></span>
            <div class="file-actions"></div>
            <div class="file-actions"></div>
            <div class="file-actions"></div>
            <div class="file-actions"></div>
          `;
          backBtn.onclick = () => {
            currentFolderId = null;
            renderFileList();
            updateToolbarTitle("My Drive");
          };
          fileListContainer.appendChild(backBtn);
        }

        // Filter content based on folderId
        let itemsToShow = [];
        if (folderId) {
          // Show files in specified folder
          itemsToShow = mockFiles.filter((file) => file.folderId === folderId);
        } else {
          // Show root directory: folders first, then files (only show files with folderId null)
          const rootFiles = mockFiles.filter(
            (file) => file.folderId === null || file.folderId === undefined
          );
          itemsToShow = [...mockFolders, ...rootFiles];
        }

        if (itemsToShow.length === 0) {
          const emptyState = document.createElement("div");
          emptyState.className = "empty-state";
          emptyState.textContent = "This folder is empty";
          fileListContainer.appendChild(emptyState);
        } else {
          itemsToShow.forEach((item) => {
            const fileItem = createFileItem(item);
            fileListContainer.appendChild(fileItem);
          });
        }
      }

      // Create file/folder item
      function createFileItem(item) {
        const div = document.createElement("div");
        div.className = "file-item";
        div.dataset.type = item.type;
        div.dataset.id = item.id;

        // If file is selected, add selected style
        if (selectedFileId === item.id) {
          div.classList.add("selected");
        }

        // Column 1: Icon + Name
        const nameCell = document.createElement("div");
        nameCell.className = "file-name-cell";
        const icon = document.createElement("span");
        icon.className = "file-icon";
        icon.textContent = item.icon;
        const name = document.createElement("span");
        name.className = "file-name";
        name.textContent = item.name;
        nameCell.appendChild(icon);
        nameCell.appendChild(name);

        // Column 2: Owner information
        const owner = document.createElement("span");
        owner.className = "file-owner";
        owner.textContent = item.owner || "Susie Doe";

        // Column 3: File size
        const size = document.createElement("span");
        size.className = "file-size";
        if (item.type === "folder") {
          size.textContent = "-";
        } else {
          size.textContent = formatFileSize(item.size);
        }

        // Column 4: Date
        const date = document.createElement("span");
        date.className = "file-date";
        date.textContent = formatDate(item.uploadDate);

        // Column 5: Share button container
        const shareCell = document.createElement("div");
        shareCell.className = "file-actions";
        const shareBtn = document.createElement("button");
        shareBtn.className = "action-btn";
        shareBtn.textContent = "Share";
        shareBtn.onclick = (e) => {
          e.stopPropagation();
          showShareModal(item);
        };
        shareCell.appendChild(shareBtn);

        // Column 6: Delete button container
        const deleteCell = document.createElement("div");
        deleteCell.className = "file-actions";
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "action-btn delete-btn";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          alert(`Deleting: ${item.name}`);
        };
        deleteCell.appendChild(deleteBtn);

        // Column 7: Download button container (for both files and folders)
        const downloadCell = document.createElement("div");
        downloadCell.className = "file-actions";
        const downloadBtn = document.createElement("button");
        downloadBtn.className = "action-btn";
        downloadBtn.textContent = "Download";
        downloadBtn.onclick = (e) => {
          e.stopPropagation();
          alert(`Downloading: ${item.name}`);
        };
        downloadCell.appendChild(downloadBtn);

        // Column 8: Move button container
        const moveCell = document.createElement("div");
        moveCell.className = "file-actions";
        const moveBtn = document.createElement("button");
        moveBtn.className = "action-btn";
        moveBtn.textContent = "Move";
        moveBtn.onclick = (e) => {
          e.stopPropagation();
          showMoveModal(item);
        };
        moveCell.appendChild(moveBtn);

        // Assemble elements
        div.appendChild(nameCell);
        div.appendChild(owner);
        div.appendChild(size);
        div.appendChild(date);
        div.appendChild(shareCell);
        div.appendChild(deleteCell);
        div.appendChild(downloadCell);
        div.appendChild(moveCell);

        // Click events
        if (item.type === "folder") {
          // Click folder: open folder
          div.style.cursor = "pointer";
          div.onclick = () => {
            currentFolderId = item.id;
            renderFileList(item.id);
            updateToolbarTitle(item.name);
          };
        } else {
          // Click file: select file
          div.style.cursor = "pointer";
          div.onclick = () => {
            // Remove previous selected state
            document.querySelectorAll(".file-item.selected").forEach((el) => {
              el.classList.remove("selected");
            });
            // Add new selected state
            div.classList.add("selected");
            selectedFileId = item.id;
          };
        }

        return div;
      }

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", () => {
        clearAuth();
        window.location.href = "index.html";
      });

      // Upload button - trigger file selection dialog
      document.getElementById("uploadBtn").addEventListener("click", () => {
        document.getElementById("fileInput").click();
      });

      // File selection handler
      document.getElementById("fileInput").addEventListener("change", (e) => {
        const files = e.target.files;
        if (files.length > 0) {
          // Display selected file information
          let fileNames = [];
          for (let i = 0; i < files.length; i++) {
            fileNames.push(files[i].name);
          }
          alert(
            `Selected ${files.length} file(s):\n${fileNames.join(
              "\n"
            )}\n\nUpload feature coming soon!`
          );

          // Reset file input to allow selecting the same file again
          e.target.value = "";
        }
      });

      // New folder - show modal
      document.getElementById("newFolderBtn").addEventListener("click", () => {
        const modal = document.getElementById("folderModal");
        const input = document.getElementById("folderNameInput");
        modal.style.display = "flex";
        input.value = "";
        input.focus();
      });

      // Confirm folder creation
      document
        .getElementById("confirmFolderBtn")
        .addEventListener("click", () => {
          const folderName = document
            .getElementById("folderNameInput")
            .value.trim();
          if (folderName) {
            createNewFolder(folderName);
            closeFolderModal();
          } else {
            alert("Please enter a folder name");
          }
        });

      // Cancel folder creation
      document
        .getElementById("cancelFolderBtn")
        .addEventListener("click", () => {
          closeFolderModal();
        });

      // Press Enter to confirm
      document
        .getElementById("folderNameInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            document.getElementById("confirmFolderBtn").click();
          }
        });

      // Click outside modal to close
      document.getElementById("folderModal").addEventListener("click", (e) => {
        if (e.target.id === "folderModal") {
          closeFolderModal();
        }
      });

      // Close modal function
      function closeFolderModal() {
        document.getElementById("folderModal").style.display = "none";
        document.getElementById("folderNameInput").value = "";
      }

      // Create new folder
      function createNewFolder(folderName) {
        // Check if folder name already exists
        const existingFolder = mockFolders.find(
          (folder) => folder.name.toLowerCase() === folderName.toLowerCase()
        );
        if (existingFolder) {
          alert("A folder with this name already exists");
          return;
        }

        // Generate new folder ID and date
        const newFolderId = "folder" + Date.now();
        const newFolder = {
          id: newFolderId,
          name: folderName,
          type: "folder",
          uploadDate: generateRandomDate(),
          icon: "üìÅ",
          owner: user.name,
        };

        // Add to folder list
        mockFolders.push(newFolder);

        // Re-render file list
        renderFileList(currentFolderId);

        // Display success message
        console.log(`Folder "${folderName}" created successfully`);
      }

      // Show share modal
      async function showShareModal(item) {
        const modal = document.getElementById("shareModal");
        const linkInput = document.getElementById("shareLinkInput");

        // Simulate calling backend API to get share token
        // Should actually call: const response = await fetch(`/api/share/link/create`, {...})
        // Here we simulate token generation
        const shareToken = await generateShareToken(item);

        // Build share link
        const shareLink = `http://localhost:8080/share/link/${shareToken}`;

        // Display link
        if (linkInput) {
          linkInput.value = shareLink;
          linkInput.style.display = "block";
        }

        if (modal) {
          modal.style.display = "flex";
        }
      }

      // Generate share token (simulate backend API)
      async function generateShareToken(item) {
        // Simulate API call delay
        await new Promise((resolve) => setTimeout(resolve, 100));

        // Generate a mock token (should actually be returned by backend)
        // Use file/folder ID and timestamp to generate unique token
        const tokenData = `${item.id}_${Date.now()}_${Math.random()
          .toString(36)
          .substr(2, 9)}`;
        const token = btoa(tokenData).replace(/[+/=]/g, (m) => {
          return { "+": "-", "/": "_", "=": "" }[m];
        });

        // Store token locally (should actually be stored by backend)
        if (!window.shareTokens) {
          window.shareTokens = {};
        }
        window.shareTokens[token] = {
          itemId: item.id,
          itemName: item.name,
          itemType: item.type,
          createdAt: new Date().toISOString(),
        };

        return token;
      }

      // Copy link button
      document.getElementById("copyLinkBtn").addEventListener("click", () => {
        const linkInput = document.getElementById("shareLinkInput");
        linkInput.select();
        linkInput.setSelectionRange(0, 99999); // Mobile support

        try {
          document.execCommand("copy");
          const copyBtn = document.getElementById("copyLinkBtn");
          const originalText = copyBtn.textContent;
          copyBtn.textContent = "Copied!";
          copyBtn.style.background = "#4caf50";
          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.style.background = "";
          }, 2000);
        } catch (err) {
          // If execCommand fails, use modern API
          navigator.clipboard.writeText(linkInput.value).then(() => {
            const copyBtn = document.getElementById("copyLinkBtn");
            const originalText = copyBtn.textContent;
            copyBtn.textContent = "Copied!";
            copyBtn.style.background = "#4caf50";
            setTimeout(() => {
              copyBtn.textContent = originalText;
              copyBtn.style.background = "";
            }, 2000);
          });
        }
      });

      // Close share modal
      document.getElementById("closeShareBtn").addEventListener("click", () => {
        document.getElementById("shareModal").style.display = "none";
      });

      // Click outside modal to close
      document.getElementById("shareModal").addEventListener("click", (e) => {
        if (e.target.id === "shareModal") {
          document.getElementById("shareModal").style.display = "none";
        }
      });

      // Show move modal
      function showMoveModal(item) {
        const modal = document.getElementById("moveModal");
        const itemNameEl = document.getElementById("moveItemName");
        const folderListEl = document.getElementById("moveFolderList");

        // Display item name to move
        itemNameEl.textContent = `Move "${item.name}" to:`;

        // Clear folder list
        folderListEl.innerHTML = "";

        // Show all available folders (exclude current item itself if it's a folder)
        mockFolders.forEach((folder) => {
          // If moving a folder, cannot move to itself
          if (item.type === "folder" && folder.id === item.id) {
            return;
          }

          const folderOption = document.createElement("div");
          folderOption.className = "folder-option";
          folderOption.dataset.folderId = folder.id;
          folderOption.innerHTML = `
            <span class="folder-icon">üìÅ</span>
            <span class="folder-name">${folder.name}</span>
          `;
          folderOption.onclick = () => {
            moveItem(item, folder.id);
            closeMoveModal();
          };
          folderListEl.appendChild(folderOption);
        });

        // Show root directory option
        const rootOption = document.querySelector(
          '.folder-option[data-folder-id="root"]'
        );
        if (rootOption) {
          rootOption.onclick = () => {
            moveItem(item, null);
            closeMoveModal();
          };
        }

        modal.style.display = "flex";
      }

      // Move file/folder
      function moveItem(item, targetFolderId) {
        if (item.type === "folder") {
          // Move folder (currently just updates display, should actually call backend API)
          console.log(
            `Moving folder "${item.name}" to folder: ${
              targetFolderId || "root"
            }`
          );
          alert(`Folder "${item.name}" moved successfully!`);
        } else {
          // Move file
          const file = mockFiles.find((f) => f.id === item.id);
          if (file) {
            file.folderId = targetFolderId;
            console.log(
              `Moving file "${item.name}" to folder: ${
                targetFolderId || "root"
              }`
            );
            // Re-render file list
            renderFileList(currentFolderId);
            alert(`File "${item.name}" moved successfully!`);
          }
        }
      }

      // Close move modal
      function closeMoveModal() {
        document.getElementById("moveModal").style.display = "none";
      }

      // Cancel move button
      document.getElementById("cancelMoveBtn").addEventListener("click", () => {
        closeMoveModal();
      });

      // Click outside modal to close
      document.getElementById("moveModal").addEventListener("click", (e) => {
        if (e.target.id === "moveModal") {
          closeMoveModal();
        }
      });

      // Search (placeholder)
      document.getElementById("searchBar").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          alert("Search feature coming soon!");
        }
      });

      // Render file list on page load
      renderFileList();
    </script>
  </body>
</html>
