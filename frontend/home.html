<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cloud Drive - My Drive</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-content">
        <h1 class="nav-title" id="homeLink" style="cursor: pointer;" title="Go to My Drive">
          <span class="logo-icon">‚òÅÔ∏è</span> Cloud Drive
        </h1>
        <div class="nav-right">
          <div class="search-container">
            <span class="search-icon">üîç</span>
            <input
              type="text"
              id="searchBar"
              placeholder="Search files..."
              class="search-bar"
            />
            <button class="search-clear-btn" id="searchClearBtn" style="display: none;">‚úï</button>
          </div>
          <button class="btn-secondary" id="uploadBtn">Upload</button>
          <button class="btn-secondary" id="newFolderBtn">New Folder</button>
          <div class="user-info">
            <span id="userName"></span>
            <button class="btn-link" id="logoutBtn">Logout</button>
          </div>
        </div>
      </div>
    </nav>

    <div class="main-container">
      <div class="content-area">
        <div class="toolbar">
          <div class="toolbar-title">
            <h2>My Drive</h2>
            <div class="storage-info" id="storageInfo">
              <div class="storage-bar">
                <div class="storage-used" id="storageUsed"></div>
              </div>
              <span class="storage-text" id="storageText">Loading...</span>
            </div>
          </div>
          <div class="filters">
            <!-- Sort dropdown with submenu -->
            <div class="sort-dropdown" id="sortDropdown">
              <button class="sort-trigger" id="sortTrigger">
                <span id="sortLabel">Sort by Name</span>
                <span class="sort-arrow">‚ñº</span>
              </button>
              <div class="sort-menu" id="sortMenu">
                <div class="sort-category">
                  <div class="sort-category-title">Name</div>
                  <div class="sort-option" data-sort="filename" data-direction="asc">
                    <span>A ‚Üí Z</span>
                    <span class="sort-check" id="check-filename-asc">‚úì</span>
                  </div>
                  <div class="sort-option" data-sort="filename" data-direction="desc">
                    <span>Z ‚Üí A</span>
                    <span class="sort-check" id="check-filename-desc"></span>
                  </div>
                </div>
                <div class="sort-category">
                  <div class="sort-category-title">Date Modified</div>
                  <div class="sort-option" data-sort="updatedat" data-direction="desc">
                    <span>Newest First</span>
                    <span class="sort-check" id="check-updatedat-desc"></span>
                  </div>
                  <div class="sort-option" data-sort="updatedat" data-direction="asc">
                    <span>Oldest First</span>
                    <span class="sort-check" id="check-updatedat-asc"></span>
                  </div>
                </div>
                <div class="sort-category">
                  <div class="sort-category-title">Size</div>
                  <div class="sort-option" data-sort="size" data-direction="desc">
                    <span>Largest First</span>
                    <span class="sort-check" id="check-size-desc"></span>
                  </div>
                  <div class="sort-option" data-sort="size" data-direction="asc">
                    <span>Smallest First</span>
                    <span class="sort-check" id="check-size-asc"></span>
                  </div>
                </div>
                <div class="sort-category">
                  <div class="sort-category-title">Type</div>
                  <div class="sort-option" data-sort="mimetype" data-direction="asc">
                    <span>A ‚Üí Z</span>
                    <span class="sort-check" id="check-mimetype-asc"></span>
                  </div>
                  <div class="sort-option" data-sort="mimetype" data-direction="desc">
                    <span>Z ‚Üí A</span>
                    <span class="sort-check" id="check-mimetype-desc"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="file-list" id="fileList">
          <!-- Files and folders will be dynamically generated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Hidden file input element -->
    <input type="file" id="fileInput" style="display: none" multiple />

    <!-- New folder modal -->
    <div id="folderModal" class="modal" style="display: none">
      <div class="modal-content">
        <h3>New Folder</h3>
        <input
          type="text"
          id="folderNameInput"
          placeholder="Enter folder name"
          maxlength="50"
        />
        <div class="modal-buttons">
          <button class="btn-primary" id="confirmFolderBtn">Confirm</button>
          <button class="btn-secondary" id="cancelFolderBtn">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Share link modal -->
    <div id="shareModal" class="modal" style="display: none">
      <div class="modal-content">
        <h3>Share Link</h3>
        <p style="margin-bottom: 15px; color: #666">
          Share this link to give others access:
        </p>
        <div class="share-link-container">
          <input
            type="text"
            id="shareLinkInput"
            readonly
            class="share-link-input"
          />
          <button class="btn-copy" id="copyLinkBtn">Copy</button>
        </div>
        <div class="modal-buttons">
          <button class="btn-secondary" id="closeShareBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- Move file/folder modal -->
    <div id="moveModal" class="modal" style="display: none">
      <div class="modal-content">
        <h3>Move to Folder</h3>
        <p style="margin-bottom: 15px; color: #666" id="moveItemName">
          Select destination folder:
        </p>
        <div class="folder-list-container">
          <div class="folder-option" data-folder-id="root">
            <span class="folder-icon">üìÅ</span>
            <span class="folder-name">My Drive (Root)</span>
          </div>
          <div id="moveFolderList"></div>
        </div>
        <div class="modal-buttons">
          <button class="btn-secondary" id="cancelMoveBtn">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Delete confirmation modal -->
    <div id="deleteModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="delete-modal-icon">üóëÔ∏è</div>
        <h3>Delete Confirmation</h3>
        <p id="deleteMessage" style="margin-bottom: 20px; color: #666; text-align: center;">
          Are you sure you want to delete this item?
        </p>
        <p id="deleteWarning" style="margin-bottom: 15px; color: #e74c3c; font-size: 13px; text-align: center; display: none;">
          ‚ö†Ô∏è This folder contains files that will also be deleted.
        </p>
        <div class="modal-buttons">
          <button class="btn-secondary" id="cancelDeleteBtn">Cancel</button>
          <button class="btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script>
      // Check authentication
      if (!isAuthenticated()) {
        window.location.href = "index.html";
      }

      // Get user from localStorage (set during login)
      const user = getUser() || { name: "User", id: "unknown" };

      // Mock user data (fallback)
      const mockUser = {
        id: "user123",
        name: "Susie Doe",
        email: "john.doe@example.com",
        storageQuota: 5368709120, // 5GB
        storageUsed: 1073741824, // 1GB
      };

      // Mock file data
      const mockFiles = [
        {
          id: "file1",
          name: "sunset.jpg",
          type: "image",
          size: 2456789, // bytes
          uploadDate: "2024-01-15",
          icon: "üñºÔ∏è",
          owner: "Susie Doe",
          folderId: null, // Root directory
        },
        {
          id: "file2",
          name: "document.pdf",
          type: "file",
          size: 1024567,
          uploadDate: "2024-01-14",
          icon: "üìÑ",
          owner: "Susie Doe",
          folderId: null, // Root directory
        },
        {
          id: "file3",
          name: "video.mp4",
          type: "video",
          size: 45678901,
          uploadDate: "2024-01-13",
          icon: "üé•",
          owner: "Susie Doe",
          folderId: null, // Root directory
        },
        {
          id: "file4",
          name: "assignment1.doc",
          type: "file",
          size: 512345,
          uploadDate: "2024-01-10",
          icon: "üìÑ",
          owner: "Susie Doe",
          folderId: "folder1", // test1 folder
        },
        {
          id: "file5",
          name: "assignment2.jpg",
          type: "image",
          size: 1890123,
          uploadDate: "2024-01-09",
          icon: "üñºÔ∏è",
          owner: "Susie Doe",
          folderId: "folder1", // test1 folder
        },
      ];

      // Mock folder data
      const mockFolders = [
        {
          id: "folder1",
          name: "test1",
          type: "folder",
          uploadDate: "2024-01-12",
          icon: "üìÅ",
          owner: "Susie Doe",
        },
        {
          id: "folder2",
          name: "test2",
          type: "folder",
          uploadDate: "2024-01-11",
          icon: "üìÅ",
          owner: "Susie Doe",
        },
      ];

      // Current folder state
      let currentFolderId = null;
      let selectedFileId = null;

      // Sort state
      let currentSortBy = 'filename';
      let currentSortDirection = 'asc';

      // Sort label mapping
      const sortLabels = {
        'filename-asc': 'Name (A‚ÜíZ)',
        'filename-desc': 'Name (Z‚ÜíA)',
        'updatedat-desc': 'Date (Newest)',
        'updatedat-asc': 'Date (Oldest)',
        'size-desc': 'Size (Largest)',
        'size-asc': 'Size (Smallest)',
        'mimetype-asc': 'Type (A‚ÜíZ)',
        'mimeType-desc': 'Type (Z‚ÜíA)'
      };

      // Display user information (use real user from login, fallback to mock)
      document.getElementById("userName").textContent = user.name || mockUser.name;

      // Generate random date (within past 30 days)
      function generateRandomDate() {
        const today = new Date();
        const daysAgo = Math.floor(Math.random() * 30);
        const date = new Date(today);
        date.setDate(date.getDate() - daysAgo);
        return date.toISOString().split("T")[0];
      }

      // Generate random dates for all files and folders
      mockFiles.forEach((file) => {
        file.uploadDate = generateRandomDate();
      });

      mockFolders.forEach((folder) => {
        folder.uploadDate = generateRandomDate();
      });

      // Format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i]
        );
      }

      // Format date
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      // Update toolbar title
      function updateToolbarTitle(title) {
        document.querySelector(".toolbar h2").textContent = title;
      }

      // Delete Confirmation Modal
      let pendingDeleteItem = null;

      function showDeleteModal(item) {
        pendingDeleteItem = item;
        const modal = document.getElementById('deleteModal');
        const message = document.getElementById('deleteMessage');
        const warning = document.getElementById('deleteWarning');
        
        if (item.type === 'folder') {
          message.innerHTML = `Are you sure you want to delete the folder<br><strong>"${item.name}"</strong>?`;
          warning.style.display = 'block';
        } else {
          message.innerHTML = `Are you sure you want to delete<br><strong>"${item.name}"</strong>?`;
          warning.style.display = 'none';
        }
        modal.style.display = 'flex';
      }

      function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        pendingDeleteItem = null;
      }

      async function performSearch() {
        const query = document.getElementById('searchBar').value.trim();
        const clearBtn = document.getElementById('searchClearBtn');
        
        if (!query) {
          document.getElementById('sortDropdown').style.display = 'block';
          clearBtn.style.display = 'none';
          await renderFileList(currentFolderId);
          updateToolbarTitle("My Drive");
          return;
        }

        clearBtn.style.display = 'block';

        try {
          document.getElementById('sortDropdown').style.display = 'none';
          updateToolbarTitle(`Search: "${query}"`);
          const fileListContainer = document.getElementById("fileList");
          fileListContainer.innerHTML = "";
          
          const headerRow = document.createElement("div");
          headerRow.className = "file-item header-row";
          headerRow.innerHTML = `
            <div class="file-name-cell"><span class="file-name">Name</span></div>
            <span class="file-owner">User</span>
            <span class="file-size">Size</span>
            <span class="file-date">Date</span>
            <div class="file-actions"></div>
            <div class="file-actions"></div>
            <div class="file-actions"></div>
            <div class="file-actions"></div>
          `;
          fileListContainer.appendChild(headerRow);

          const loadingDiv = document.createElement("div");
          loadingDiv.className = "empty-state";
          loadingDiv.textContent = "Searching...";
          fileListContainer.appendChild(loadingDiv);

          const response = await searchFiles(query, currentSortBy, currentSortDirection);
          loadingDiv.remove();

          const files = (response.data?.files || response.files || []).map(f => ({
            id: f.fileId,
            name: f.filename,
            type: getFileType(f.mimeType),
            size: f.size,
            uploadDate: f.createdAt || f.updatedAt,
            icon: getFileIcon(f.mimeType),
            owner: user.name,
            folderId: f.folderId
          }));

          if (files.length === 0) {
            const emptyState = document.createElement("div");
            emptyState.className = "empty-state";
            emptyState.textContent = "No files found";
            fileListContainer.appendChild(emptyState);
          } else {
            files.forEach((item) => {
              const fileItem = createFileItem(item);
              fileListContainer.appendChild(fileItem);
            });
          }

          const resultsBar = document.createElement("div");
          resultsBar.className = "search-results-bar";
          resultsBar.innerHTML = `
            <button class="all-results-btn" id="allResultsBtn">
              <span>‚Üê</span>
              <span>Back</span>
            </button>
          `;
          fileListContainer.appendChild(resultsBar);

          document.getElementById('allResultsBtn').addEventListener('click', async () => {
            document.getElementById('searchBar').value = '';
            document.getElementById('searchClearBtn').style.display = 'none';
            document.getElementById('sortDropdown').style.display = 'block';
            updateToolbarTitle("My Drive");
            await renderFileList(currentFolderId);
          });

        } catch (error) {
          console.error('Search failed:', error);
          alert(`Search failed: ${error.message}`);
        }
      }

      // Storage quota (5GB)
      const STORAGE_QUOTA = 5 * 1024 * 1024 * 1024;

      async function loadStorageInfo() {
        try {
          const response = await getFileStats();
          const stats = response.stats || response.data?.stats || response;
          const totalSize = stats.totalSize || 0;
          const percentage = Math.min((totalSize / STORAGE_QUOTA) * 100, 100);
          
          const storageUsed = document.getElementById('storageUsed');
          storageUsed.style.width = `${percentage}%`;
          
          storageUsed.classList.remove('warning', 'danger');
          if (percentage >= 90) {
            storageUsed.classList.add('danger');
          } else if (percentage >= 70) {
            storageUsed.classList.add('warning');
          }
          
          const usedText = totalSize >= 1024 * 1024 
            ? (totalSize / (1024 * 1024)).toFixed(1) + ' MB'
            : (totalSize / 1024).toFixed(1) + ' KB';
          document.getElementById('storageText').textContent = `${usedText} of 15 GB used`;
        } catch (error) {
          console.error('Failed to load storage info:', error);
          document.getElementById('storageText').textContent = '';
        }
      }

      loadStorageInfo();

      // Render file and folder list
      async function renderFileList(folderId = null) {
        const fileListContainer = document.getElementById("fileList");
        fileListContainer.innerHTML = "";

        // Add header row
        const headerRow = document.createElement("div");
        headerRow.className = "file-item header-row";
        headerRow.innerHTML = `
          <div class="file-name-cell">
            <span class="file-name">Name</span>
          </div>
          <span class="file-owner">User</span>
          <span class="file-size">Size</span>
          <span class="file-date">Date</span>
          <div class="file-actions"></div>
          <div class="file-actions"></div>
          <div class="file-actions"></div>
          <div class="file-actions"></div>
        `;
        fileListContainer.appendChild(headerRow);

        // If there's a current folder, show back button
        if (folderId) {
          const backBtn = document.createElement("div");
          backBtn.className = "file-item back-item";
          backBtn.innerHTML = `
            <div class="file-name-cell">
              <span class="file-icon">‚Üê</span>
              <span class="file-name">Back</span>
            </div>
            <span class="file-owner"></span>
            <span class="file-size"></span>
            <span class="file-date"></span>
            <div class="file-actions"></div>
            <div class="file-actions"></div>
            <div class="file-actions"></div>
            <div class="file-actions"></div>
          `;
          backBtn.onclick = () => {
            currentFolderId = null;
            renderFileList();
            updateToolbarTitle("My Drive");
          };
          fileListContainer.appendChild(backBtn);
        }

        // Show loading state
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "empty-state";
        loadingDiv.textContent = "Loading...";
        fileListContainer.appendChild(loadingDiv);

        try {
          // get folder content
          const targetFolderId = folderId || 'root';
          const folderResponse = await getFolderContent(targetFolderId);
          const foldersRaw = folderResponse.data?.folders || folderResponse.folders || [];
          const filesResponse = await listFilesWithSort(currentSortBy, currentSortDirection, targetFolderId);
          const filesRaw = filesResponse.data?.files || filesResponse.files || [];

        // Remove loading state
          loadingDiv.remove();

        // format folders data
          const folders = foldersRaw.map(f => ({
              id: f.folderId,
              name: f.name,
              type: 'folder',
              uploadDate: f.createdAt || f.updatedAt,
              icon: 'üìÅ',
              owner: user.name
          }));

        // sort folders by name
          folders.sort((a, b) => a.name.localeCompare(b.name));

        // format files data
          const files = filesRaw.map(f => ({
            id: f.fileId,
            name: f.filename,
            type: getFileType(f.mimeType),
            size: f.size,
            uploadDate: f.createdAt || f.updatedAt,
            icon: getFileIcon(f.mimeType),
            owner: user.name,
            folderId: f.folderId
          }));

          const itemsToShow = [...folders, ...files];

          if (itemsToShow.length === 0) {
            const emptyState = document.createElement("div");
            emptyState.className = "empty-state";
            emptyState.textContent = "This folder is empty";
            fileListContainer.appendChild(emptyState);
          } else {
            itemsToShow.forEach((item) => {
              const fileItem = createFileItem(item);
              fileListContainer.appendChild(fileItem);
            });
          }

          // Store folders for move modal
          allFolders = folders;

        } catch (error) {
          console.error('Failed to load folder content:', error);
          loadingDiv.textContent = 'Failed to load. Using demo data...';
          
          // Fallback to mock data if API fails
          setTimeout(() => {
            loadingDiv.remove();
            let itemsToShow = [];
            if (folderId) {
              itemsToShow = mockFiles.filter((file) => file.folderId === folderId);
            } else {
              const rootFiles = mockFiles.filter(
                (file) => file.folderId === null || file.folderId === undefined
              );
              itemsToShow = [...mockFolders, ...rootFiles];
            }
            itemsToShow.forEach((item) => {
              const fileItem = createFileItem(item);
              fileListContainer.appendChild(fileItem);
            });
          }, 1000);
        }
      }

      // Helper: Get file type from MIME type
      function getFileType(mimeType) {
        if (!mimeType) return 'file';
        if (mimeType.startsWith('image/')) return 'image';
        if (mimeType.startsWith('video/')) return 'video';
        if (mimeType.startsWith('audio/')) return 'audio';
        if (mimeType === 'application/pdf') return 'pdf';
        return 'file';
      }

      // Helper: Get file icon from MIME type
      function getFileIcon(mimeType) {
        if (!mimeType) return 'üìÑ';
        if (mimeType.startsWith('image/')) return 'üñºÔ∏è';
        if (mimeType.startsWith('video/')) return 'üé•';
        if (mimeType.startsWith('audio/')) return 'üéµ';
        if (mimeType === 'application/pdf') return 'üìÉ';
        if (mimeType.includes('word') || mimeType.includes('document')) return 'üìù';
        if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'üìä';
        return 'üìÑ'; 
      }

      // Store all folders for move modal
      let allFolders = [];

      // Create file/folder item
      function createFileItem(item) {
        const div = document.createElement("div");
        div.className = "file-item";
        div.dataset.type = item.type;
        div.dataset.id = item.id;

        // If file is selected, add selected style
        if (selectedFileId === item.id) {
          div.classList.add("selected");
        }

        // Column 1: Icon + Name
        const nameCell = document.createElement("div");
        nameCell.className = "file-name-cell";
        const icon = document.createElement("span");
        icon.className = "file-icon";
        icon.textContent = item.icon;
        const name = document.createElement("span");
        name.className = "file-name";
        name.textContent = item.name;
        nameCell.appendChild(icon);
        nameCell.appendChild(name);

        // Column 2: Owner information
        const owner = document.createElement("span");
        owner.className = "file-owner";
        owner.textContent = item.owner || "Susie Doe";

        // Column 3: File size
        const size = document.createElement("span");
        size.className = "file-size";
        if (item.type === "folder") {
          size.textContent = "-";
        } else {
          size.textContent = formatFileSize(item.size);
        }

        // Column 4: Date
        const date = document.createElement("span");
        date.className = "file-date";
        date.textContent = formatDate(item.uploadDate);

        // Column 5: Share button container
        const shareCell = document.createElement("div");
        shareCell.className = "file-actions";
        const shareBtn = document.createElement("button");
        shareBtn.className = "action-btn";
        shareBtn.textContent = "Share";
        shareBtn.onclick = (e) => {
          e.stopPropagation();
          showShareModal(item);
        };
        shareCell.appendChild(shareBtn);

        // Column 6: Delete button container
        const deleteCell = document.createElement("div");
        deleteCell.className = "file-actions";
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "action-btn delete-btn";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = async (e) => {
          e.stopPropagation();
          showDeleteModal(item);
        };
        deleteCell.appendChild(deleteBtn);

        // Column 7: Download button container
        const downloadCell = document.createElement("div");
        downloadCell.className = "file-actions";
        const downloadBtn = document.createElement("button");
        downloadBtn.className = "action-btn";
        if (item.type === "folder") {

          downloadBtn.textContent = "View";
          downloadBtn.onclick = (e) => {
            e.stopPropagation();
            currentFolderId = item.id;
            renderFileList(item.id);
            updateToolbarTitle(item.name);
          };
        } else {
          downloadBtn.textContent = "Download";
          downloadBtn.onclick = async (e) => {
            e.stopPropagation();
            try {
              await downloadFile(item.id);
              console.log(`Download initiated: ${item.name}`);
            } catch (error) {
              alert(`Failed to download: ${error.message}`);
              console.error('Download error:', error);
            }
          };
        }
        downloadCell.appendChild(downloadBtn);
        

        // Column 8: Move button container
        const moveCell = document.createElement("div");
        moveCell.className = "file-actions";
        const moveBtn = document.createElement("button");
        moveBtn.className = "action-btn";
        moveBtn.textContent = "Move";
        moveBtn.onclick = (e) => {
          e.stopPropagation();
          showMoveModal(item);
        };
        moveCell.appendChild(moveBtn);

        // Assemble elements
        div.appendChild(nameCell);
        div.appendChild(owner);
        div.appendChild(size);
        div.appendChild(date);
        div.appendChild(shareCell);
        div.appendChild(deleteCell);
        div.appendChild(downloadCell);
        div.appendChild(moveCell);

        // Click events
        if (item.type === "folder") {
          // Click folder: open folder
          div.style.cursor = "pointer";
          div.onclick = () => {
            currentFolderId = item.id;
            renderFileList(item.id);
            updateToolbarTitle(item.name);
          };
        } else {
          // Click file: select file
          div.style.cursor = "pointer";
          div.onclick = () => {
            // Remove previous selected state
            document.querySelectorAll(".file-item.selected").forEach((el) => {
              el.classList.remove("selected");
            });
            // Add new selected state
            div.classList.add("selected");
            selectedFileId = item.id;
          };
        }

        return div;
      }

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", () => {
        clearAuth();
        window.location.href = "index.html";
      });

      // Upload button - trigger file selection dialog
      document.getElementById("uploadBtn").addEventListener("click", () => {
        document.getElementById("fileInput").click();
      });

      // File selection handler
      document.getElementById("fileInput").addEventListener("change", async (e) => {
        const files = e.target.files;
        if (files.length > 0) {
          // Upload each file
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            try {
              // Show uploading message
              const uploadingMsg = document.createElement("div");
              uploadingMsg.className = "empty-state";
              uploadingMsg.id = "uploadingMsg";
              uploadingMsg.textContent = `Uploading ${file.name}...`;
              document.getElementById("fileList").appendChild(uploadingMsg);

              // Call real API to upload file
              await uploadFile(file, currentFolderId);
              
              // Remove uploading message
              document.getElementById("uploadingMsg")?.remove();
              
              console.log(`File "${file.name}" uploaded successfully`);
            } catch (error) {
              document.getElementById("uploadingMsg")?.remove();
              alert(`Failed to upload ${file.name}: ${error.message}`);
              console.error('Upload error:', error);
            }
          }
          
          // Refresh file list after all uploads
          await renderFileList(currentFolderId);
          
          // Reset file input to allow selecting the same file again
          e.target.value = "";
        }
      });

      // New folder - show modal
      document.getElementById("newFolderBtn").addEventListener("click", () => {
        const modal = document.getElementById("folderModal");
        const input = document.getElementById("folderNameInput");
        modal.style.display = "flex";
        input.value = "";
        input.focus();
      });

      // Confirm folder creation
      document
        .getElementById("confirmFolderBtn")
        .addEventListener("click", async () => {
          const folderName = document
            .getElementById("folderNameInput")
            .value.trim();
          if (folderName) {
            closeFolderModal();
            await createNewFolder(folderName);
          } else {
            alert("Please enter a folder name");
          }
        });

      // Cancel folder creation
      document
        .getElementById("cancelFolderBtn")
        .addEventListener("click", () => {
          closeFolderModal();
        });

      // Press Enter to confirm
      document
        .getElementById("folderNameInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            document.getElementById("confirmFolderBtn").click();
          }
        });

      // Click outside modal to close
      document.getElementById("folderModal").addEventListener("click", (e) => {
        if (e.target.id === "folderModal") {
          closeFolderModal();
        }
      });

      // Close modal function
      function closeFolderModal() {
        document.getElementById("folderModal").style.display = "none";
        document.getElementById("folderNameInput").value = "";
      }

      // Create new folder
      async function createNewFolder(folderName) {
        try {
          // Call real API to create folder
          const parentId = currentFolderId || 'root';
          await createFolder(folderName, parentId);
          
          console.log(`Folder "${folderName}" created successfully`);
          
          // Refresh file list
          await renderFileList(currentFolderId);
        } catch (error) {
          alert(`Failed to create folder: ${error.message}`);
          console.error('Create folder error:', error);
        }
      }

      // Show share modal
      async function showShareModal(item) {
        const modal = document.getElementById("shareModal");
        const linkInput = document.getElementById("shareLinkInput");

        // Simulate calling backend API to get share token
        // Should actually call: const response = await fetch(`/api/share/link/create`, {...})
        // Here we simulate token generation
        const shareToken = await generateShareToken(item);

        // Build share link
        const shareLink = `http://localhost:8080/share/link/${shareToken}`;

        // Display link
        if (linkInput) {
          linkInput.value = shareLink;
          linkInput.style.display = "block";
        }

        if (modal) {
          modal.style.display = "flex";
        }
      }

      // Generate share token
      async function generateShareToken(item) {
        // Simulate API call delay
        await new Promise((resolve) => setTimeout(resolve, 100));

        // Generate a mock token (should actually be returned by backend)
        // Use file/folder ID and timestamp to generate unique token
        const tokenData = `${item.id}_${Date.now()}_${Math.random()
          .toString(36)
          .substr(2, 9)}`;
        const token = btoa(tokenData).replace(/[+/=]/g, (m) => {
          return { "+": "-", "/": "_", "=": "" }[m];
        });

        // Store token locally (should actually be stored by backend)
        if (!window.shareTokens) {
          window.shareTokens = {};
        }
        window.shareTokens[token] = {
          itemId: item.id,
          itemName: item.name,
          itemType: item.type,
          createdAt: new Date().toISOString(),
        };

        return token;
      }

      // Copy link button
      document.getElementById("copyLinkBtn").addEventListener("click", () => {
        const linkInput = document.getElementById("shareLinkInput");
        linkInput.select();
        linkInput.setSelectionRange(0, 99999); // Mobile support

        try {
          document.execCommand("copy");
          const copyBtn = document.getElementById("copyLinkBtn");
          const originalText = copyBtn.textContent;
          copyBtn.textContent = "Copied!";
          copyBtn.style.background = "#4caf50";
          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.style.background = "";
          }, 2000);
        } catch (err) {
          // If execCommand fails, use modern API
          navigator.clipboard.writeText(linkInput.value).then(() => {
            const copyBtn = document.getElementById("copyLinkBtn");
            const originalText = copyBtn.textContent;
            copyBtn.textContent = "Copied!";
            copyBtn.style.background = "#4caf50";
            setTimeout(() => {
              copyBtn.textContent = originalText;
              copyBtn.style.background = "";
            }, 2000);
          });
        }
      });

      // Close share modal
      document.getElementById("closeShareBtn").addEventListener("click", () => {
        document.getElementById("shareModal").style.display = "none";
      });

      // Click outside modal to close
      document.getElementById("shareModal").addEventListener("click", (e) => {
        if (e.target.id === "shareModal") {
          document.getElementById("shareModal").style.display = "none";
        }
      });

      // Show move modal
      async function showMoveModal(item) {
        const modal = document.getElementById("moveModal");
        const itemNameEl = document.getElementById("moveItemName");
        const folderListEl = document.getElementById("moveFolderList");

        // Display item name to move
        itemNameEl.textContent = `Move "${item.name}" to:`;

        // Clear folder list
        folderListEl.innerHTML = "";

        try {
          // Fetch all folders from API
          const response = await listFolders();
          const folders = response.data?.folders || response.folders || allFolders || [];

          // Show all available folders (exclude current item itself if it's a folder)
          folders.forEach((folder) => {
            const fId = folder.folderId || folder.id;
            // If moving a folder, cannot move to itself
            if (item.type === "folder" && fId === item.id) {
              return;
            }

            const folderOption = document.createElement("div");
            folderOption.className = "folder-option";
            folderOption.dataset.folderId = fId;
            folderOption.innerHTML = `
              <span class="folder-icon">üìÅ</span>
              <span class="folder-name">${folder.name}</span>
            `;
            folderOption.onclick = async () => {
              closeMoveModal();
              await moveItemToFolder(item, fId);
            };
            folderListEl.appendChild(folderOption);
          });
        } catch (error) {
          console.error('Failed to load folders:', error);
          // Fallback to allFolders from last render
          allFolders.forEach((folder) => {
            if (item.type === "folder" && folder.id === item.id) return;
            const folderOption = document.createElement("div");
            folderOption.className = "folder-option";
            folderOption.dataset.folderId = folder.id;
            folderOption.innerHTML = `
              <span class="folder-icon">üìÅ</span>
              <span class="folder-name">${folder.name}</span>
            `;
            folderOption.onclick = async () => {
              closeMoveModal();
              await moveItemToFolder(item, folder.id);
            };
            folderListEl.appendChild(folderOption);
          });
        }

        // Show root directory option
        const rootOption = document.querySelector(
          '.folder-option[data-folder-id="root"]'
        );
        if (rootOption) {
          rootOption.onclick = async () => {
            closeMoveModal();
            await moveItemToFolder(item, 'root');
          };
        }

        modal.style.display = "flex";
      }

      // Move file/folder
      async function moveItemToFolder(item, targetFolderId) {
        try {
          if (item.type === "folder") {
            await moveFolder(item.id, targetFolderId);
            console.log(`Moved folder "${item.name}" to folder: ${targetFolderId}`);
          } else {
            await moveFile(item.id, targetFolderId);
            console.log(`Moved file "${item.name}" to folder: ${targetFolderId}`);
          }
          // Refresh file list
          await renderFileList(currentFolderId);
        } catch (error) {
          alert(`Failed to move: ${error.message}`);
          console.error('Move error:', error);
        }
      }

      // Close move modal
      function closeMoveModal() {
        document.getElementById("moveModal").style.display = "none";
      }

      // Cancel move button
      document.getElementById("cancelMoveBtn").addEventListener("click", () => {
        closeMoveModal();
      });

      // Click outside modal to close
      document.getElementById("moveModal").addEventListener("click", (e) => {
        if (e.target.id === "moveModal") {
          closeMoveModal();
        }
      });

      // Search on Enter key
      document.getElementById("searchBar").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          performSearch();
        }
      });

      // Show/hide clear button based on input
      document.getElementById("searchBar").addEventListener("input", (e) => {
        const clearBtn = document.getElementById('searchClearBtn');
        clearBtn.style.display = e.target.value.trim() ? 'block' : 'none';
      });

      // Clear search
      document.getElementById("searchClearBtn").addEventListener("click", async () => {
        document.getElementById('searchBar').value = '';
        document.getElementById('searchClearBtn').style.display = 'none';
        document.getElementById('sortDropdown').style.display = 'block';
        updateToolbarTitle("My Drive");
        await renderFileList(currentFolderId);
      });

      // ========================================
      // Sort Dropdown Functionality
      // ========================================
      const sortDropdown = document.getElementById('sortDropdown');
      const sortTrigger = document.getElementById('sortTrigger');
      const sortMenu = document.getElementById('sortMenu');
      const sortLabel = document.getElementById('sortLabel');

      // Toggle dropdown
      sortTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        sortDropdown.classList.toggle('open');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!sortDropdown.contains(e.target)) {
          sortDropdown.classList.remove('open');
        }
      });

      // Handle sort option click
      document.querySelectorAll('.sort-option').forEach(option => {
        option.addEventListener('click', async () => {
          const sortBy = option.dataset.sort;
          const direction = option.dataset.direction;
          
          // Update state
          currentSortBy = sortBy;
          currentSortDirection = direction;
          
          // Update UI - clear all checks
          document.querySelectorAll('.sort-check').forEach(check => {
            check.textContent = '';
          });
          
          // Add check to selected option
          const checkId = `check-${sortBy}-${direction}`;
          const checkEl = document.getElementById(checkId);
          if (checkEl) {
            checkEl.textContent = '‚úì';
          }
          
          // Update all options active state
          document.querySelectorAll('.sort-option').forEach(opt => {
            opt.classList.remove('active');
          });
          option.classList.add('active');
          
          // Update label
          const labelKey = `${sortBy}-${direction}`;
          sortLabel.textContent = sortLabels[labelKey] || 'Sort';
          
          // Close dropdown
          sortDropdown.classList.remove('open');
          
          // Refresh file list with new sort
          await renderFileList(currentFolderId);
        });
      });

      // ========================================
      // Home Link - Click to go back to root
      // ========================================
      document.getElementById('homeLink').addEventListener('click', async () => {
        currentFolderId = null;
        document.getElementById('searchBar').value = '';
        document.getElementById('sortDropdown').style.display = 'block';
        updateToolbarTitle('My Drive');
        await renderFileList(null);
      });

      document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
        if (!pendingDeleteItem) return;
        const item = pendingDeleteItem;
        closeDeleteModal();
        
        try {
          if (item.type === 'folder') {
            await deleteFolder(item.id);
          } else {
            await deleteFile(item.id);
          }
          console.log(`Deleted: ${item.name}`);
          await renderFileList(currentFolderId);
        } catch (error) {
          alert(`Failed to delete: ${error.message}`);
          console.error('Delete error:', error);
        }
      });

      document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteModal);

      document.getElementById('deleteModal').addEventListener('click', (e) => {
        if (e.target.id === 'deleteModal') {
          closeDeleteModal();
        }
      });

      // Render file list on page load
      renderFileList();
    </script>
  </body>
</html>